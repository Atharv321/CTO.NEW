# Alerting Service Documentation

## Overview

The alerting service provides real-time notifications for critical inventory events, including low stock alerts, impending expiration warnings, and supplier order updates. It supports multiple notification channels (email, SMS, push, in-app) with user-configurable preferences and threshold-based alerting.

## Features

### üö® Alert Types
- **Low Stock Alerts**: Triggered when inventory falls below configured thresholds
- **Impending Expiration Alerts**: Warns about products approaching expiration
- **Supplier Order Updates**: Notifies about order status changes
- **System Error Alerts**: Reports critical system failures

### üì¢ Notification Channels
- **Email**: Mock SendGrid integration with 95% success rate simulation
- **SMS**: Mock SMS provider with 90% success rate simulation
- **Push**: Mock push notification service with 85% success rate simulation
- **In-App**: Real-time notifications stored in database

### ‚öôÔ∏è User Preferences
- Role-based default preferences
- Per-user alert type subscriptions
- Channel enable/disable controls
- Minimum severity thresholds
- Quiet hours configuration

### üîÑ Background Processing
- Automatic queue processing every 30 seconds
- Threshold monitoring every 2 minutes
- Retry mechanism with exponential backoff
- Graceful shutdown handling

## API Endpoints

### Notifications
- `GET /api/alerts/notifications` - Get user's in-app notifications
- `PUT /api/alerts/notifications/:id/read` - Mark notification as read
- `PUT /api/alerts/notifications/read-all` - Mark all notifications as read

### Alert Thresholds
- `GET /api/alerts/thresholds` - Get alert thresholds
- `POST /api/alerts/thresholds` - Create alert threshold
- `PUT /api/alerts/thresholds/:id` - Update alert threshold
- `DELETE /api/alerts/thresholds/:id` - Delete alert threshold

### Alert History
- `GET /api/alerts/history` - Get alert event history

### Test Endpoints
- `POST /api/alerts/test/supplier-order` - Create test supplier order alert
- `POST /api/alerts/test/system-error` - Create test system error alert
- `POST /api/alerts/process-queue` - Manually trigger queue processing

### User Preferences
- `GET /api/alerts/preferences` - Get user notification preferences
- `PUT /api/alerts/preferences` - Update user notification preferences

## Database Schema

### Tables

#### `alert_events`
Stores all alert events generated by the system.

```sql
CREATE TABLE alert_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  type VARCHAR(50) NOT NULL,
  severity VARCHAR(20) NOT NULL,
  title VARCHAR(255) NOT NULL,
  message TEXT NOT NULL,
  data JSONB,
  user_id UUID REFERENCES users(id),
  location_id UUID REFERENCES locations(id),
  product_id UUID REFERENCES products(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  processed_at TIMESTAMP
);
```

#### `alert_thresholds`
Configurable thresholds for different alert conditions.

```sql
CREATE TABLE alert_thresholds (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  location_id UUID REFERENCES locations(id),
  product_id UUID REFERENCES products(id),
  type VARCHAR(50) NOT NULL,
  threshold DECIMAL(10,2) NOT NULL,
  unit VARCHAR(50) NOT NULL,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(location_id, product_id, type)
);
```

#### `user_notification_preferences`
User-specific notification settings.

```sql
CREATE TABLE user_notification_preferences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  alert_types TEXT[] NOT NULL,
  channels JSONB NOT NULL,
  min_severity VARCHAR(20) NOT NULL,
  quiet_hours JSONB,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id)
);
```

#### `notifications`
Tracks all notification attempts across channels.

```sql
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  alert_event_id UUID NOT NULL REFERENCES alert_events(id),
  channel_type VARCHAR(20) NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'pending',
  sent_at TIMESTAMP,
  error TEXT,
  retry_count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### `in_app_notifications`
Stores in-app notifications for users.

```sql
CREATE TABLE in_app_notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  title VARCHAR(255) NOT NULL,
  message TEXT NOT NULL,
  severity VARCHAR(20) NOT NULL,
  read BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  read_at TIMESTAMP
);
```

## Configuration

### Environment Variables
```bash
# Database connection
DATABASE_URL=postgresql://user:password@localhost:5432/analytics_db

# Redis connection (for caching)
REDIS_URL=redis://localhost:6379

# API configuration
API_PORT=3000
FRONTEND_URL=http://localhost:3000

# JWT secret for authentication
JWT_SECRET=your-secret-key
```

### Alert Thresholds
Default thresholds are configured per product and location:

```json
{
  "type": "low_stock",
  "threshold": 10,
  "unit": "units",
  "locationId": "location-uuid",
  "productId": "product-uuid",
  "isActive": true
}
```

### User Preferences
Default preferences by role:

- **Admin**: All alert types, all channels, minimum severity = LOW
- **Manager**: Business alerts, email + in-app, minimum severity = MEDIUM  
- **Analyst**: Analytics alerts, email + in-app, minimum severity = MEDIUM
- **Staff**: Low stock + expiration, in-app only, minimum severity = HIGH

## Usage Examples

### Creating Alert Thresholds
```bash
curl -X POST http://localhost:3000/api/alerts/thresholds \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "type": "low_stock",
    "threshold": 15,
    "unit": "units",
    "locationId": "location-uuid",
    "productId": "product-uuid",
    "isActive": true
  }'
```

### Getting Notifications
```bash
curl -X GET http://localhost:3000/api/alerts/notifications \
  -H "Authorization: Bearer <token>" \
  -H "x-user-id: user-uuid"
```

### Updating Preferences
```bash
curl -X PUT http://localhost:3000/api/alerts/preferences \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -H "x-user-id: user-uuid" \
  -d '{
    "alertTypes": ["low_stock", "impending_expiration"],
    "channels": [
      {"type": "email", "enabled": true, "config": {}},
      {"type": "in_app", "enabled": true, "config": {}}
    ],
    "minSeverity": "medium",
    "quietHours": {"start": "22:00", "end": "06:00"},
    "isActive": true
  }'
```

## Development

### Running Tests
```bash
# Run all tests
npm test

# Run specific test file
npm test src/tests/alerts.test.ts

# Run tests with coverage
npm test -- --coverage
```

### Database Setup
```bash
# Run migrations
npm run migrate

# Seed base data
npm run seed

# Seed alerting-specific test data
npm run seed-alerting
```

### Development Server
```bash
# Start development server with alerting worker
npm run dev
```

## Monitoring

### Health Checks
The service provides health endpoints:
- `/health` - Overall service health
- `/api/alerts/process-queue` - Manual queue processing

### Logging
Alerting service logs include:
- üö® Alert creation events
- üìß Email notification attempts
- üì± SMS notification attempts  
- üîî Push notification attempts
- üì± In-app notification creation
- ‚ö†Ô∏è Failed notifications and retries

### Performance Metrics
- Queue processing time
- Notification delivery success rates
- Alert generation frequency
- User engagement with in-app notifications

## Security

### Authentication
All endpoints require JWT authentication except health checks. User identification is done via:
- `Authorization: Bearer <token>` header
- `x-user-id` header for user context

### Authorization
Role-based access control:
- **Admin**: Full access to all alerting features
- **Manager**: Can manage thresholds, view history, update preferences
- **Analyst**: View-only access to alerts and history
- **Staff**: Limited to personal notifications

### Data Privacy
- User preferences are isolated per user
- Notification content respects data access rules
- Audit trail maintained for all alert events

## Troubleshooting

### Common Issues

#### Notifications Not Sending
1. Check notification queue: `POST /api/alerts/process-queue`
2. Verify user preferences: `GET /api/alerts/preferences`
3. Check alert thresholds: `GET /api/alerts/thresholds`
4. Review service logs for errors

#### High Alert Volume
1. Adjust thresholds to reduce noise
2. Configure quiet hours for users
3. Increase minimum severity settings
4. Review alert cooldown periods

#### Database Performance
1. Check indexes on alert tables
2. Monitor notification queue growth
3. Consider archiving old alert events
4. Optimize alert generation queries

### Debug Mode
Enable debug logging by setting:
```bash
DEBUG=alerts:* npm run dev
```

## Future Enhancements

### Planned Features
- [ ] Real-time WebSocket notifications
- [ ] Alert aggregation and batching
- [ ] Custom alert rules engine
- [ ] Mobile app push notifications
- [ ] Alert analytics and reporting
- [ ] Integration with external monitoring systems
- [ ] SLA-based alerting
- [ ] Multi-tenant alert isolation

### Performance Improvements
- [ ] Redis-based notification queuing
- [ ] Background job processing with Bull
- [ ] Database connection pooling optimization
- [ ] Caching for user preferences
- [ ] Alert deduplication algorithms